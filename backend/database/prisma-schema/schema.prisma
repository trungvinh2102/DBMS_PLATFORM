// This is the simplified schema for the SQL Lab platform.
// It focuses on database connections and query management.

generator client {
  provider = "prisma-client-js"
  engineType = "library"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/// Represents a connection to an external database (e.g., Postgres, MySQL, Snowflake).
model Db {
  id          String   @id @default(uuid())
  type        String   // e.g., "postgres", "mysql", "bigquery"
  
  // Environment Classification
  environment Environment @default(DEVELOPMENT)
  
  // Security & Governance
  isReadOnly  Boolean  @default(false)
  sslMode     SSLMode  @default(DISABLE)
  sshConfig   Json?    // Stores { host, port, user, privateKey, type }
  tags        String[] // ["finance", "pci-dss"]
  
  // Explicit Connection Details (migrating from config)
  username     String?
  password     String? // Encrypted string
  databaseName String
  host         String?
  port         Int?
  
  // Stores connection details (host, port, user, pass, database name or full connection string).
  config      Json     

  savedQueries  SavedQuery[]
  queryHistories QueryHistory[]

  created_on   DateTime @default(now()) @map("created_on")
  changed_on   DateTime @default(now()) @updatedAt @map("changed_on")

  @@map("databases")
}


/// Stores SQL queries saved by users for future use.
model SavedQuery {
  id          String   @id @default(uuid())
  name        String
  description String?
  sql         String
  
  databaseId  String
  database    Db @relation(fields: [databaseId], references: [id], onDelete: Cascade)

  userId      String?
  user        User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  created_on   DateTime @default(now()) @map("created_on")
  changed_on   DateTime @default(now()) @updatedAt @map("changed_on")

  @@index([userId])
  @@map("saved_queries")
}

/// Keeps track of executed queries for auditing and history.
model QueryHistory {
  id          String   @id @default(uuid())
  sql         String
  status      String   // "SUCCESS", "FAILED", "RUNNING"
  executionTime Int?   // in milliseconds
  errorMessage String?
  
  databaseId  String
  database    Db @relation(fields: [databaseId], references: [id], onDelete: Cascade)

  executedAt  DateTime @default(now())
  
  created_on   DateTime @default(now()) @map("created_on")
  changed_on   DateTime @default(now()) @updatedAt @map("changed_on")

  @@index([executedAt])
  @@map("query_histories")
}

/// Represents a user of the platform.
model User {
  id        String   @id @default(uuid())
  email     String   @unique
  username  String   @unique
  password  String   // Hashed password
  name      String?
  
  // RBAC: User belongs to a specific Role
  roleId    String
  role      Role     @relation(fields: [roleId], references: [id])

  savedQueries SavedQuery[]

  settings UserSetting?

  created_on DateTime @default(now()) @map("created_on")
  changed_on DateTime @default(now()) @updatedAt @map("changed_on")

  @@map("users")
}

/// Stores user-specific settings and preferences.
model UserSetting {
  id     String @id @default(uuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Stores all UI and editor settings in a JSON object
  settings Json 

  created_on DateTime @default(now()) @map("created_on")
  changed_on DateTime @default(now()) @updatedAt @map("changed_on")

  @@map("user_settings")
}

/// Defines a role within the system (e.g., Admin, Creator, Viewer).
model Role {
  id          String       @id @default(uuid())
  name        String       @unique // e.g., "Admin", "Creator", "Viewer", "Default"
  description String?

  users       User[]
  
  // A role can have multiple privileges
  rolePrivileges RolePrivilege[]

  created_on   DateTime @default(now()) @map("created_on")
  changed_on   DateTime @default(now()) @updatedAt @map("changed_on")

  @@map("roles")
}

/// Defines the types of privileges available in the system
model PrivilegeType {
  id          String   @id @default(uuid())
  code        String   @unique // e.g., "READ_MASKED", "EXPORT_CSV"
  category    PrivilegeCategory
  description String?

  rolePrivileges RolePrivilege[]

  created_on   DateTime @default(now()) @map("created_on")
  changed_on   DateTime @default(now()) @updatedAt @map("changed_on")

  @@map("privilege_types")
}

/// Maps roles to privilege types with specific resource constraints and conditions
model RolePrivilege {
  id              String   @id @default(uuid())
  
  roleId          String
  role            Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)
  
  privilegeTypeId String
  privilegeType   PrivilegeType @relation(fields: [privilegeTypeId], references: [id], onDelete: Cascade)
  
  resourceType    ResourceType
  resourceId      String?   // specific resource ID or "*" for all
  
  conditionExpr   String?   // JSON or text based policy condition
  
  created_on      DateTime @default(now()) @map("created_on")
  changed_on      DateTime @default(now()) @updatedAt @map("changed_on")

  @@map("role_privileges")
  @@index([roleId])
  @@index([privilegeTypeId])
}

enum PrivilegeCategory {
  DATA_ACCESS
  DATA_MUTATION
  QUERY_CAPABILITY
  DATA_EXFILTRATION
  SENSITIVE
  SYSTEM
}

enum ResourceType {
  TABLE
  COLUMN
  DATASET
  API
  SYSTEM
}

enum Environment {
  PRODUCTION
  STAGING
  DEVELOPMENT
}

enum SSLMode {
  DISABLE
  REQUIRE
  VERIFY_CA
  VERIFY_FULL
}
